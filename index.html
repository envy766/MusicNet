<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MusicNet ‚Äî Playlist Player (Enhanced)</title>
<style>
:root{
  --bg1:#0f1020;
  --bg2:#0b2545;
  --accent:#6ef0ff;
  --accent2:#8a4fff;
  --accent3:#ff66cc;
  --neon:#6ef0ff;
  --glass: rgba(255,255,255,0.03);
}

/* reset & layout */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Poppins",sans-serif;background:
  linear-gradient(145deg,var(--bg1),var(--bg2));color:#fff;display:flex;align-items:center;justify-content:center;}

/* canvas background full-screen */
canvas#bg{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  z-index:0;                /* changed: base layer (was -2) */
  pointer-events:none;      /* allow clicks through canvas */
}

/* page footer (background center bottom) */
.page-footer{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  font-size:11px;
  color:rgba(255,255,255,0.06);
  pointer-events:none;
  z-index:1;                /* above canvas but below player */
  letter-spacing:0.4px;
}

/* player */
.player{
  width:380px;
  max-width:95vw;
  max-height:86vh;
  /* make background semi-transparent so canvas shows through */
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.04);
  border-radius:14px;
  box-shadow:0 20px 60px rgba(2,6,23,0.6);
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  position:relative;
  overflow:hidden;
  z-index:2;                 /* top layer */
  backdrop-filter: blur(6px);/* blur background to blend with canvas */
}

/* toolbar (search, genre, hide/show, fav-only) */
.toolbar{display:flex;gap:8px;align-items:center;}
.search{
  flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);
  background:rgba(255,255,255,0.02);color:#fff;font-size:0.88rem;
}
.select-btn{
  padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);
  background:transparent;color:var(--neon);font-size:0.88rem;cursor:pointer;
  backdrop-filter: blur(4px);
}
.icon-btn{
  padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);
  background:transparent;color:var(--neon);cursor:pointer;
}

/* genre panel (custom multi-select) */
.genre-panel{
  position:absolute;
  top:56px;
  left:16px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.04);
  padding:8px;
  border-radius:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  min-width:180px;
  box-shadow:0 8px 30px rgba(2,6,23,0.6);
  z-index:3;
}
.genre-chip{
  display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;
  background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);
  font-size:0.86rem;color:rgba(255,255,255,0.9);cursor:pointer;
}
.genre-chip input{accent-color:var(--accent);}

/* header area: logo + visualizer */
.top {
  display:flex;flex-direction:column;align-items:center;gap:8px;
}
#logo{
  width:92px;height:92px;border-radius:50%;
  background:radial-gradient(circle,var(--accent),transparent);
  box-shadow:0 0 30px rgba(110,240,255,0.12);
  transition:transform .12s linear, box-shadow .12s linear;
  display:block;
}
#visualizer{width:100%;height:34px;display:flex;align-items:end;justify-content:center;gap:4px; padding:0 8px;}
#visualizer span{width:6px;height:8px;border-radius:3px;background:var(--accent);box-shadow:0 0 8px rgba(110,240,255,0.12);transition:height .08s linear,opacity .12s linear;}

/* track info */
.title{font-weight:700;font-size:1.05rem;text-align:center;line-height:1.1}
.artist{font-size:0.85rem;color:rgba(255,255,255,0.75);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* controls row */
.controls{display:flex;align-items:center;justify-content:space-between;gap:8px}
.btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--neon);cursor:pointer}
.btn.active{color:#fff;text-shadow:0 0 10px var(--accent)}
.big{width:68px;height:68px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.06);font-size:26px;cursor:pointer}

/* volume/progress row */
.row{display:flex;align-items:center;gap:8px}
.volume-container{display:flex;align-items:center;gap:8px;flex:1}
#volume{width:100%;accent-color:var(--accent)}
.time{font-size:0.82rem;color:rgba(255,255,255,0.72);min-width:46px;text-align:center}

/* progress bar */
.progress{width:100%;height:8px;background:rgba(255,255,255,0.03);border-radius:999px;position:relative;cursor:pointer}
.progress .bar{height:100%;width:0;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 6px 20px rgba(110,240,255,0.08);transition:width .1s linear}

/* playlist area expanded - responsive height */
.playlist-wrap{flex:1;overflow:hidden;display:flex;flex-direction:column;gap:6px}
/* adjust max height relative to viewport so more items visible */
.playlist{overflow:auto;padding-right:6px;border-radius:8px;max-height:calc(100vh - 340px)}
.item{
  padding:8px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;gap:8px;
  cursor:pointer;transition:background .12s ease;
}
.item:hover{background:rgba(110,240,255,0.04)}
.item .meta{flex:1;min-width:0}
.item .t{font-weight:600;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item .a{font-size:0.78rem;color:rgba(255,255,255,0.7);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item.active{background:linear-gradient(90deg, rgba(110,240,255,0.06), rgba(138,79,255,0.06));box-shadow:0 0 12px rgba(110,240,255,0.08)}

/* favorite star */
.fav{font-size:1.1rem;color:rgba(255,255,255,0.45);user-select:none;padding-left:8px}
.fav.active{color:var(--accent3);text-shadow:0 0 8px var(--accent3)}

/* playback rate display */
#rateDisplay{font-size:0.8rem;color:rgba(255,255,255,0.7);min-width:42px;text-align:center}

/* hide playlist */
.playlist.hidden{display:none}

/* responsive */
@media(max-width:420px){
  .player{width:92vw;}
  #logo{width:78px;height:78px}
}
</style>
</head>
<body>
<canvas id="bg" aria-hidden="true"></canvas>

<div class="player" aria-live="polite">
  <div class="toolbar" style="position:relative;">
    <input id="search" class="search" placeholder="Cari lagu atau artis..." aria-label="Cari lagu" />
    <button id="genreBtn" class="select-btn" aria-haspopup="true" aria-expanded="false">Genre ‚ñæ</button>
    <div id="genrePanel" class="genre-panel" style="display:none;">
      <!-- chips inserted by JS -->
    </div>
    <button id="toggleList" class="icon-btn" title="Hide/show playlist">‚ñ§</button>
    <button id="favOnly" class="icon-btn" title="Tampilkan favorit">‚òÖ</button>
  </div>

  <div class="top">
    <div id="logo" aria-hidden="true"></div>
    <div id="visualizer" aria-hidden="true">
      <span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span>
    </div>
  </div>

  <div>
    <div class="title" id="title">Memuat...</div>
    <div class="artist" id="artist"></div>
  </div>

  <div class="controls" role="group" aria-label="Kontrol audio">
    <button id="shuffle" class="btn" title="Shuffle">üîÄ</button>
    <button id="prev" class="btn" title="Previous">‚èÆÔ∏è</button>
    <button id="play" class="big" title="Play">‚ñ∂Ô∏è</button>
    <button id="next" class="btn" title="Next">‚è≠Ô∏è</button>
    <button id="repeat" class="btn" title="Repeat">üîÅ</button>
  </div>

  <div class="row">
    <div class="volume-container">
      <button id="mute" class="btn" title="Mute">üîä</button>
      <input id="volume" type="range" min="0" max="1" step="0.01" />
    </div>
    <div id="rateDisplay">1.0√ó</div>
  </div>

  <div class="row" style="align-items:center;">
    <div class="time" id="curTime">0:00.0</div>
    <div class="progress" id="progress" aria-label="progress">
      <div class="bar" id="bar"></div>
    </div>
    <div class="time" id="durTime">0:00.0</div>
  </div>

  <div class="playlist-wrap">
    <div class="playlist" id="playlist" role="list"></div>
  </div>
</div>

<div class="page-footer">Created By Afrizal In October 2025</div>

<audio id="audio" crossorigin="anonymous"></audio>

<script>
/* ------------------------
   Background canvas (reactive)
   ------------------------ */
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth;
let H = canvas.height = innerHeight;
addEventListener('resize', ()=>{ W=canvas.width=innerWidth; H=canvas.height=innerHeight; });

const particles=[];
for(let i=0;i<120;i++){
  particles.push({ x: Math.random()*W, y: Math.random()*H, r: Math.random()*1.6+0.6, dx:(Math.random()-0.5)*0.6, dy:(Math.random()-0.5)*0.6 });
}

let audioCtx, analyser, dataArray;
function setupAudioAnalyzer(audioEl){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const src = audioCtx.createMediaElementSource(audioEl);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  dataArray = new Uint8Array(analyser.frequencyBinCount);
  src.connect(analyser);
  analyser.connect(audioCtx.destination);
}

let beatLevel = 0;
function draw(){
  requestAnimationFrame(draw);
  ctx.clearRect(0,0,W,H);

  if(analyser){
    analyser.getByteFrequencyData(dataArray);
    const lowCount = Math.max(4, Math.floor(dataArray.length*0.08));
    let sum=0; for(let i=0;i<lowCount;i++) sum+=dataArray[i];
    const avg = sum/lowCount/255;
    let total=0; for(let i=0;i<dataArray.length;i++) total+=dataArray[i];
    const overall = total/dataArray.length/255;
    beatLevel = Math.max(beatLevel*0.85, avg);
    window.__music_overall = overall;
  } else {
    beatLevel *= 0.92;
    window.__music_overall = Math.max(0,(window.__music_overall||0)*0.98);
  }

  const t = Date.now()*0.001;
  for(let x=0;x<W;x+=7){
    const amp = 18 + 60*beatLevel;
    const y = H/2 + Math.sin(x*0.012 + t)*amp + Math.sin(x*0.006 + t*2)*(amp*0.6);
    ctx.fillStyle = `rgba(110,240,255,${0.08 + beatLevel*0.5})`;
    ctx.fillRect(x, y, 2, 2);
  }

  const overall = window.__music_overall || 0;
  particles.forEach(p=>{
    p.x += p.dx * (1 + overall*2);
    p.y += p.dy * (1 + overall*2);
    if(p.x < -10) p.x = W + 10;
    if(p.x > W + 10) p.x = -10;
    if(p.y < -10) p.y = H + 10;
    if(p.y > H + 10) p.y = -10;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r * (1 + overall*1.5), 0, Math.PI*2);
    ctx.fillStyle = `rgba(138,79,255,${0.06 + overall*0.45})`;
    ctx.fill();
  });
}
draw();

/* ------------------------
   Player logic
   ------------------------ */
const playlistURL = 'playlist.json';
const audio = document.getElementById('audio');
const playBtn = document.getElementById('play');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const shuffleBtn = document.getElementById('shuffle');
const repeatBtn = document.getElementById('repeat');
const titleEl = document.getElementById('title');
const artistEl = document.getElementById('artist');
const bar = document.getElementById('bar');
const progress = document.getElementById('progress');
const curTimeEl = document.getElementById('curTime');
const durTimeEl = document.getElementById('durTime');
const playlistEl = document.getElementById('playlist');
const searchInput = document.getElementById('search');
const genreBtn = document.getElementById('genreBtn');
const genrePanel = document.getElementById('genrePanel');
const favOnlyBtn = document.getElementById('favOnly');
const toggleListBtn = document.getElementById('toggleList');
const logoEl = document.getElementById('logo');
const visualBars = document.querySelectorAll('#visualizer span');
const volumeSlider = document.getElementById('volume');
const muteBtn = document.getElementById('mute');
const rateDisplay = document.getElementById('rateDisplay');

let playlist = [];
let filteredIndexes = [];
let favorites = JSON.parse(localStorage.getItem('musicnet_favorites')||'[]');
let savedState = JSON.parse(localStorage.getItem('musicnet_last')||'{}');
let currentIndex = 0;
let isPlaying = false;
let isShuffle = false;
let isRepeat = false;
let showFavOnly = false;
let visInterval = null;

const ALLOWED_GENRES = ['pop','poprock','slow','breakbeat','cover'];
let selectedGenres = []; // multi-select

/* parse genre from track tags (we assume playlist uses t.tags array) */
function tagsToLower(arr){
  return (arr||[]).map(x=>String(x).toLowerCase().trim());
}

/* load playlist.json */
async function loadPlaylist(){
  try{
    const res = await fetch(playlistURL, {cache:'no-store'});
    if(!res.ok) throw new Error('playlist.json not found');
    playlist = await res.json();
    // normalize: ensure each track has .file and .tags array
    playlist = playlist.map(p=>{
      return {
        file: p.url || p.file || p.src || '',
        title: p.title || p.name || '',
        artist: p.artist || '',
        tags: Array.isArray(p.tags) ? tagsToLower(p.tags) : (p.tags ? tagsToLower(String(p.tags).split(',').map(s=>s.trim())) : [])
      };
    });
    buildGenrePanel();
    applyFilters();
    if(savedState && typeof savedState.index === 'number' && playlist[savedState.index]){
      currentIndex = savedState.index;
      loadTrack(currentIndex);
      if(savedState.time) audio.currentTime = savedState.time;
    } else if(playlist.length) loadTrack(0);
  }catch(err){
    console.error(err);
    titleEl.textContent = 'Gagal memuat playlist.json';
  }
}

/* build genre panel as chips with checkboxes (transparent theme) */
function buildGenrePanel(){
  genrePanel.innerHTML = '';
  ALLOWED_GENRES.forEach(g=>{
    const chip = document.createElement('label');
    chip.className = 'genre-chip';
    chip.innerHTML = `<input type="checkbox" value="${g}" ${selectedGenres.includes(g)?'checked':''}/> ${g}`;
    chip.addEventListener('click', (ev)=>{
      const cb = chip.querySelector('input');
      cb.checked = !cb.checked;
      toggleGenre(g, cb.checked);
      ev.stopPropagation();
    });
    genrePanel.appendChild(chip);
  });
}

/* toggle genre selection */
function toggleGenre(g, checked){
  if(checked){
    if(!selectedGenres.includes(g)) selectedGenres.push(g);
  } else {
    selectedGenres = selectedGenres.filter(x=>x!==g);
  }
  applyFilters();
}

/* apply filters: search, selectedGenres (multi), favorites */
function applyFilters(){
  const q = (searchInput.value||'').trim().toLowerCase();
  playlistEl.innerHTML = '';
  filteredIndexes = [];
  playlist.forEach((t,i)=>{
    if(showFavOnly && !favorites.includes(t.file)) return;
    if(selectedGenres.length){
      // include track if any of its tags intersects selectedGenres
      const ok = t.tags.some(tag => selectedGenres.includes(tag));
      if(!ok) return;
    }
    const searchable = ((t.title||'') + ' ' + (t.artist||'')).toLowerCase();
    if(q && !searchable.includes(q)) return;
    filteredIndexes.push(i);
  });
  filteredIndexes.forEach(i => createListItem(i));
}

/* create list DOM item */
function createListItem(i){
  const t = playlist[i];
  const row = document.createElement('div');
  row.className = 'item';
  row.dataset.i = i;
  if(i === currentIndex) row.classList.add('active');

  const meta = document.createElement('div'); meta.className = 'meta';
  const tt = document.createElement('div'); tt.className = 't'; tt.textContent = t.title || 'Tanpa Judul';
  const aa = document.createElement('div'); aa.className = 'a'; aa.textContent = t.artist || '';
  meta.appendChild(tt); meta.appendChild(aa);

  const fav = document.createElement('div'); fav.className = 'fav'; fav.textContent = favorites.includes(t.file) ? '‚òÖ' : '‚òÜ';
  if(favorites.includes(t.file)) fav.classList.add('active');

  row.appendChild(meta);
  row.appendChild(fav);

  // click handlers
  row.addEventListener('click', (ev) => {
    if(ev.target === fav || ev.target.classList.contains('fav')){
      toggleFavorite(t.file, fav);
      ev.stopPropagation();
      return;
    }
    currentIndex = i;
    loadTrack(currentIndex);
    playAudio();
  });

  playlistEl.appendChild(row);
}

/* toggle favorite */
function toggleFavorite(file, dom){
  if(favorites.includes(file)){
    favorites = favorites.filter(f => f !== file);
    dom.textContent = '‚òÜ';
    dom.classList.remove('active');
  } else {
    favorites.push(file);
    dom.textContent = '‚òÖ';
    dom.classList.add('active');
  }
  localStorage.setItem('musicnet_favorites', JSON.stringify(favorites));
}

/* load track */
function loadTrack(i){
  if(!playlist[i]) return;
  currentIndex = i;
  const t = playlist[i];
  audio.src = t.file;
  titleEl.textContent = t.title || 'Tanpa Judul';
  artistEl.textContent = t.artist || '';
  document.querySelectorAll('.item').forEach(el => el.classList.toggle('active', Number(el.dataset.i) === i));
  saveLast();
}

/* play/pause */
function playAudio(){
  try{ if(!audioCtx) setupAudioAnalyzer(audio); }catch(e){ console.warn(e) }
  audio.play().catch(()=>{ /* may be blocked until gesture */ });
  isPlaying = true;
  playBtn.textContent = '‚è∏Ô∏è';
  logoEl.style.animationPlayState = 'running';
  startVisualizer();
}
function pauseAudio(){
  audio.pause();
  isPlaying = false;
  playBtn.textContent = '‚ñ∂Ô∏è';
  logoEl.style.animationPlayState = 'paused';
  stopVisualizer();
}
playBtn.addEventListener('click', ()=> isPlaying ? pauseAudio() : playAudio());

/* prev/next */
prevBtn.addEventListener('click', ()=>{
  if(audio.currentTime > 3){ audio.currentTime = 0; return; }
  currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
  loadTrack(currentIndex);
  playAudio();
});
nextBtn.addEventListener('click', ()=> nextTrack());

function nextTrack(){
  if(isRepeat){
    audio.currentTime = 0;
    playAudio();
    return;
  }
  if(isShuffle) currentIndex = Math.floor(Math.random() * playlist.length);
  else currentIndex = (currentIndex + 1) % playlist.length;
  loadTrack(currentIndex);
  playAudio();
}

/* shuffle/repeat toggles */
shuffleBtn.addEventListener('click', ()=> { isShuffle = !isShuffle; shuffleBtn.classList.toggle('active', isShuffle); });
repeatBtn.addEventListener('click', ()=> { isRepeat = !isRepeat; repeatBtn.classList.toggle('active', isRepeat); });

/* time formatting with 1 decimal second */
function fmtTimeDecimal(s){
  if(!isFinite(s)) return '0:00.0';
  const m = Math.floor(s/60);
  const sec = Math.floor(s%60).toString().padStart(2,'0');
  const dec = Math.floor((s - Math.floor(s)) * 10);
  return `${m}:${sec}.${dec}`;
}
audio.addEventListener('timeupdate', ()=>{
  const cur = audio.currentTime || 0;
  const dur = audio.duration || 0;
  curTimeEl.textContent = fmtTimeDecimal(cur);
  durTimeEl.textContent = dur ? fmtTimeDecimal(dur) : '0:00.0';
  if(dur) bar.style.width = (cur / dur * 100) + '%';
  if(Math.floor(cur) % 2 === 0) saveLast();
  // dynamic logo glow
  const glow = 6 + (beatLevel || 0) * 40;
  const scale = 1 + (beatLevel || 0) * 0.18;
  logoEl.style.boxShadow = `0 0 ${Math.max(8,glow)}px rgba(110,240,255,${0.18 + (beatLevel||0)*0.6})`;
  logoEl.style.transform = `scale(${scale})`;
  // update rate display (in case changed by drag)
  rateDisplay.textContent = audio.playbackRate.toFixed(1) + '√ó';
});

/* pointer seeking + playbackRate vertical drag */
let seeking = false;
let adjustingRate = false;
let startY = 0;
let startRate = 1;
progress.addEventListener('pointerdown', (e)=>{
  progress.setPointerCapture(e.pointerId);
  seeking = true;
  startY = e.clientY;
  startRate = audio.playbackRate || 1;
  // default: allow horizontal seek; but if user moves vertically > 8px, we treat as rate adjust
  window.addEventListener('pointermove', onPointerMove);
  window.addEventListener('pointerup', onPointerUp);
  seek(e);
});
function onPointerMove(e){
  const dy = (startY - e.clientY);
  if(Math.abs(dy) > 8){
    // start adjusting rate
    adjustingRate = true;
    const delta = dy / 200; // drag 200px => +1.0
    let newRate = Math.min(3, Math.max(0.5, startRate + delta));
    audio.playbackRate = newRate;
    rateDisplay.textContent = newRate.toFixed(1) + '√ó';
  } else if(seeking && !adjustingRate){
    seek(e);
  }
}
function onPointerUp(e){
  try{ progress.releasePointerCapture(e.pointerId); }catch(_){}
  if(seeking){
    if(!adjustingRate && audio.duration){
      // final seek
      seek(e);
    }
  }
  seeking = false;
  adjustingRate = false;
  window.removeEventListener('pointermove', onPointerMove);
  window.removeEventListener('pointerup', onPointerUp);
}
function seek(e){
  const rect = progress.getBoundingClientRect();
  let x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
  x = Math.max(0, Math.min(rect.width, x));
  const pct = x / rect.width;
  if(audio.duration && !adjustingRate) audio.currentTime = pct * audio.duration;
  if(!adjustingRate) bar.style.width = (pct*100) + '%';
}

/* volume & mute */
volumeSlider.value = localStorage.getItem('musicnet_volume') || 0.7;
audio.volume = Number(volumeSlider.value);
volumeSlider.addEventListener('input', ()=>{
  audio.volume = Number(volumeSlider.value);
  localStorage.setItem('musicnet_volume', String(audio.volume));
});
muteBtn.addEventListener('click', ()=>{
  if(audio.muted){
    audio.muted = false;
    muteBtn.textContent = 'üîä';
  } else {
    audio.muted = true;
    muteBtn.textContent = 'üîá';
  }
});

/* save last track/time */
function saveLast(){
  try{
    localStorage.setItem('musicnet_last', JSON.stringify({ index: currentIndex, time: audio.currentTime || 0 }));
  }catch(e){}
}

/* toolbar interactions */
searchInput.addEventListener('input', applyFilters);
favOnlyBtn.addEventListener('click', ()=>{
  showFavOnly = !showFavOnly;
  favOnlyBtn.classList.toggle('active', showFavOnly);
  applyFilters();
});

/* hide/show playlist (efficient) */
toggleListBtn.addEventListener('click', ()=>{
  const wrap = document.querySelector('.playlist-wrap');
  wrap.classList.toggle('hidden');
  toggleListBtn.textContent = wrap.classList.contains('hidden') ? '‚ñ•' : '‚ñ§';
});

/* genre panel open/close */
genreBtn.addEventListener('click', (ev)=>{
  const open = genrePanel.style.display !== 'none';
  genrePanel.style.display = open ? 'none' : 'flex';
  genreBtn.setAttribute('aria-expanded', (!open).toString());
});
document.addEventListener('click', (ev)=>{
  if(!genrePanel.contains(ev.target) && ev.target !== genreBtn){
    genrePanel.style.display = 'none';
    genreBtn.setAttribute('aria-expanded','false');
  }
});

/* visualizer: use analyser to update bars; fallback random */
function startVisualizer(){
  stopVisualizer();
  visInterval = setInterval(()=>{
    if(analyser && dataArray){
      analyser.getByteFrequencyData(dataArray);
      const N = visualBars.length;
      for(let i=0;i<N;i++){
        const idx = Math.floor((i / N) * dataArray.length);
        const val = dataArray[idx] || 0;
        const h = Math.max(6, (val / 255) * 28);
        visualBars[i].style.height = h + 'px';
        visualBars[i].style.opacity = (0.3 + (val/255)*0.7).toFixed(2);
      }
      const lowCount = Math.max(4, Math.floor(dataArray.length * 0.08));
      let s=0; for(let i=0;i<lowCount;i++) s+=dataArray[i];
      const avg = s / lowCount / 255;
      beatLevel = Math.max(beatLevel*0.8, avg);
    } else {
      visualBars.forEach(b => { const h = Math.random()*20 + 6; b.style.height = h + 'px'; b.style.opacity = (Math.random()*0.5+0.5).toFixed(2); });
      beatLevel *= 0.95;
    }
  }, 80);
}
function stopVisualizer(){ if(visInterval) clearInterval(visInterval); visInterval = null; visualBars.forEach(b=>{ b.style.height = '6px'; b.style.opacity = '0.9'; }); }

/* audio ended -> next */
audio.addEventListener('ended', ()=> nextTrack());

/* initial load */
loadPlaylist();
</script>
</body>
</html>
